name: Sync D1 Data(user)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Fetch and update D1 data
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ“¦ æ­£åœ¨ä» Cloudflare D1 è·å–æ•°æ®..."
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/query" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"sql":"SELECT * FROM user"}' | \
          jq '.result[0].results' | jq '{list: .}' > public/userlist.json

          if [ "$(jq '.list | length' public/userlist.json)" -eq 0 ]; then
            echo "âœ… æ²¡æœ‰ä»»ä½•å¯æ¯”è¾ƒçš„å†…å®¹ï¼Œè¿è¡Œæ­£å¸¸ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

      - name: Compare and push changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git fetch origin main

          OLD_FILE_EXISTS=0
          if git ls-tree -r origin/main --name-only | grep -q '^public/userlist.json$'; then
            mkdir -p old_public
            git show origin/main:public/userlist.json > old_public/userlist.json
            OLD_FILE_EXISTS=1
          fi

          if [ "$OLD_FILE_EXISTS" -eq 1 ] && cmp -s old_public/userlist.json public/userlist.json; then
            echo "âœ… public/userlist.json ä¸ origin/main ç›¸åŒï¼Œæš‚æ— å˜åŒ–ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

          BRANCH="d1-sync"
          git checkout -B "$BRANCH"
          git add public/userlist.json
          git commit -m "chore: sync D1 data ($(date +%Y-%m-%d))" || echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜åŒ–å¯æäº¤"
          git push origin "$BRANCH" -f

      - name: Wait for branch sync
        run: sleep 5

      - name: Create or update Pull Request (with label)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="d1-sync"
          LABEL="CloudflareD1 auto-sync"

          echo "ğŸª„ æ£€æŸ¥æ˜¯å¦å·²æœ‰ PR..."
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')

          echo "ğŸ” æ£€æŸ¥ä¸ main çš„å·®å¼‚..."
          if [ "$(git rev-list origin/main..origin/$BRANCH | wc -l)" -eq 0 ]; then
            echo "âœ… main ä¸ $BRANCH æ²¡æœ‰ä»»ä½•å·®å¼‚ï¼Œè·³è¿‡ PR åˆ›å»ºã€‚"
            exit 0
          fi

          if [ -n "$EXISTING_PR" ]; then
            echo "ğŸ”„ å·²å­˜åœ¨ PR #$EXISTING_PRï¼Œæ›´æ–°åˆ†æ”¯å®Œæˆã€‚"
            gh pr edit "$EXISTING_PR" --add-label "$LABEL" || echo "âš ï¸ æ— æ³•æ·»åŠ æ ‡ç­¾ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ã€‚"
          else
            echo "âœ¨ åˆ›å»ºæ–°çš„ PR..."
            gh pr create \
              --title "Update D1 data ($(date +%Y-%m-%d))" \
              --body "Automated data sync from Cloudflare D1. I need @Iamliuxiaozhen to handle this pull request." \
              --base main \
              --head "$BRANCH"

            NEW_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
            if [ -n "$NEW_PR" ]; then
              echo "ğŸ·ï¸ ä¸ºæ–° PR #$NEW_PR æ·»åŠ æ ‡ç­¾ $LABEL"
              gh pr edit "$NEW_PR" --add-label "$LABEL" || echo "âš ï¸ æ— æ³•æ·»åŠ æ ‡ç­¾ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ã€‚"
            fi
          fi