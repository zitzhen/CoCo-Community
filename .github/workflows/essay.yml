name: Sync D1 Data(essay)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl gh ruby

      # ç”Ÿæˆ GitHub App Installation Token
      - name: Generate GitHub App Installation Token
        id: generate_token
        run: |
          echo "${{ secrets.AGITHUB_APP_PRIVATE_KEY }}" > private-key.pem

          jwt=$(ruby -ropenssl -rbase64 -rjson -e '
            require "jwt"
            t = Time.now.to_i
            payload = { iat: t, exp: t + 600, iss: ENV["APP_ID"] }
            key = OpenSSL::PKey::RSA.new(File.read("private-key.pem"))
            puts JWT.encode(payload, key, "RS256")
          ')

          token=$(curl -s -X POST \
            -H "Authorization: Bearer $jwt" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations/${INSTALLATION_ID}/access_tokens \
            | jq -r .token)

          echo "token=$token" >> $GITHUB_OUTPUT
        env:
          APP_ID: ${{ secrets.AGITHUB_APP_ID }}
          INSTALLATION_ID: ${{ secrets.AGITHUB_APP_INSTALLATION_ID }}

      - name: Fetch and update D1 data
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ“¦ æ­£åœ¨ä» Cloudflare D1 è·å–æ•°æ®..."
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/d1/database/$DATABASE_ID/query" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"sql":"SELECT * FROM essay"}' | \
          jq '.result[0].results' | jq '{list: .}' > public/essaylist.json

          if [ "$(jq '.list | length' public/essaylist.json)" -eq 0 ]; then
            echo "âœ… æ²¡æœ‰ä»»ä½•å¯æ¯”è¾ƒçš„å†…å®¹ï¼Œè¿è¡Œæ­£å¸¸ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

      - name: Compare and push changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git fetch origin main

          OLD_FILE_EXISTS=0
          if git ls-tree -r origin/main --name-only | grep -q '^public/essaylist.json$'; then
            mkdir -p old_public
            git show origin/main:public/essaylist.json > old_public/essaylist.json
            OLD_FILE_EXISTS=1
          fi

          if [ "$OLD_FILE_EXISTS" -eq 1 ] && cmp -s old_public/essaylist.json public/essaylist.json; then
            echo "âœ… public/essaylist.json ä¸ origin/main ç›¸åŒï¼Œæš‚æ— å˜åŒ–ï¼Œç»“æŸå·¥ä½œæµã€‚"
            exit 0
          fi

          BRANCH="d1-sync"
          git checkout -B "$BRANCH"
          git add public/essaylist.json
          git commit -m "chore: sync D1 data ($(date +%Y-%m-%d))" || echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜åŒ–å¯æäº¤"
          git push origin "$BRANCH" -f

      - name: Wait for branch sync
        run: sleep 5

      - name: Create or update Pull Request, then attempt auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_APP_INSTALLATION_TOKEN: ${{ steps.generate_token.outputs.token }}   #  æ”¹ä¸ºåŠ¨æ€ç”Ÿæˆçš„ä»¤ç‰Œ
        run: |
          set -euo pipefail
          BRANCH="d1-sync"
          LABEL="CloudflareD1 auto-sync"

          echo "ğŸª„ æ£€æŸ¥æ˜¯å¦å·²æœ‰ PR..."
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' || true)

          echo "ğŸ” æ£€æŸ¥ä¸ main çš„å·®å¼‚..."
          if [ "$(git rev-list origin/main..origin/$BRANCH | wc -l)" -eq 0 ]; then
            echo "âœ… main ä¸ $BRANCH æ²¡æœ‰ä»»ä½•å·®å¼‚ï¼Œè·³è¿‡ PR åˆ›å»ºã€‚"
            exit 0
          fi

          PR_NUM=""
          if [ -n "$EXISTING_PR" ]; then
            PR_NUM="$EXISTING_PR"
            echo "ğŸ”„ å·²å­˜åœ¨ PR #$PR_NUMï¼Œæ›´æ–°åˆ†æ”¯å®Œæˆã€‚"
            gh pr edit "$PR_NUM" --add-label "$LABEL" || echo "âš ï¸ æ— æ³•æ·»åŠ æ ‡ç­¾ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ã€‚"
          else
            echo "âœ¨ åˆ›å»ºæ–°çš„ PR..."
            gh pr create \
              --title "Update D1 data ($(date +%Y-%m-%d))" \
              --body "Automated data sync from Cloudflare D1. I need @Iamliuxiaozhen to handle this pull request." \
              --base main \
              --head "$BRANCH"

            PR_NUM=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' || true)
            if [ -n "$PR_NUM" ]; then
              echo "ğŸ·ï¸ ä¸ºæ–° PR #$PR_NUM æ·»åŠ æ ‡ç­¾ $LABEL"
              gh pr edit "$PR_NUM" --add-label "$LABEL" || echo "âš ï¸ æ— æ³•æ·»åŠ æ ‡ç­¾ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨ã€‚"
            fi
          fi

          if [ -z "$PR_NUM" ]; then
            echo "âš ï¸ æœªèƒ½è·å– PR ç¼–å·ï¼Œé€€å‡ºã€‚"
            exit 0
          fi

          echo "ğŸ” å°è¯•ä½¿ç”¨ Action èº«ä»½åˆå¹¶ PR #$PR_NUMï¼ˆä¸èƒ½ç»•è¿‡å—ä¿æŠ¤åˆ†æ”¯çš„å¼ºåˆ¶ç­¾åï¼‰ã€‚"
          if gh pr merge "$PR_NUM" --merge --delete-branch --body "Auto-merged by workflow" >/dev/null 2>&1; then
            echo "âœ… PR #$PR_NUM å·²ç”± Action èº«ä»½åˆå¹¶ã€‚"
            exit 0
          fi

          echo "âš ï¸ Action èº«ä»½åˆå¹¶å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ GitHub App å®‰è£…ä»¤ç‰Œå›é€€åˆå¹¶ã€‚"

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/$PR_NUM/merge"
          merge_payload='{"commit_title":"Auto-merge D1 sync","commit_message":"Automated data sync from Cloudflare D1.","merge_method":"merge"}'

          HTTP_CODE=$(curl -s -o /tmp/merge_resp -w "%{http_code}" -X PUT "$API_URL" \
            -H "Authorization: Bearer ${GITHUB_APP_INSTALLATION_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "$merge_payload")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… PR #$PR_NUM å·²ç”± GitHub App å®‰è£…ä»¤ç‰Œåˆå¹¶ã€‚"
          else
            echo "âŒ ä½¿ç”¨ GitHub App åˆå¹¶å¤±è´¥ (HTTP $HTTP_CODE)ï¼š"
            cat /tmp/merge_resp || true
            echo "ä¿ç•™ PR ä¾›äººå·¥å¤„ç†æˆ–å…¶ä»–è‡ªåŠ¨åŒ–å·¥å…·å¤„ç†ã€‚"
          fi