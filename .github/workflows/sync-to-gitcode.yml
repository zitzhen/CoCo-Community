name: Sync GitHub Repo to Gitcode
permissions:
  contents: read

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯æ¨é€äº‹ä»¶
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync-main:
    name: Sync Main Repo to Gitcode
    runs-on: ubuntu-latest
    env:
      GITCODE_USERNAME: Liu_xiaozhen
      GITCODE_ORG: zitzhen
      GITCODE_REPO: CoCo-Community
      GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•
          submodules: recursive  # é€’å½’è·å–å­æ¨¡å—

      - name: Setup Git Config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clone GitHub Repo
        run: |
          echo "ğŸš€ å…‹éš† GitHub ä¸»ä»“åº“..."
          git clone --bare https://github.com/zitzhen/CoCo-Community.git repo
          cd repo

          echo "ğŸ”— æ·»åŠ  Gitcode è¿œç¨‹ä»“åº“..."
          git remote remove gitcode 2>/dev/null || true
          git remote add gitcode "https://${GITCODE_USERNAME}:${GITCODE_TOKEN}@gitcode.com/${GITCODE_ORG}/${GITCODE_REPO}.git"

          echo "âœ… éªŒè¯è¿œç¨‹ï¼š"
          git remote -v

          echo "â¬†ï¸ æ¨é€æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾åˆ° Gitcode..."
          git push gitcode --all --verbose || echo "âš ï¸ æ¨é€åˆ†æ”¯æ—¶é‡åˆ°é—®é¢˜"
          git push gitcode --tags --verbose || echo "âš ï¸ æ¨é€æ ‡ç­¾æ—¶é‡åˆ°é—®é¢˜"

          echo "ğŸ‰ ä¸»ä»“åº“æ¨é€åˆ° Gitcode å®Œæˆï¼"